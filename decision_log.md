# Storm Master Field App — Decision Log

Use this log to record significant technical, product, or process decisions made during the build. Each entry should include enough detail for future contributors to understand the context, rationale, and impact.

## Entry Template

| ID | Date | Phase / Section | Decision | Rationale | Impact / Follow-ups | Owner |
|----|------|-----------------|----------|-----------|----------------------|-------|
| DL-001 | 2025-11-20 | Phase 1-1 / 1.1 Choose Tech Stack | Adopt Flutter 3.x with Dart + Riverpod state mgmt | Plan already optimized for Flutter; strong offline plugins (Drift, geolocator), single codebase, existing team familiarity | Initialize Flutter repo, document tooling versions, align onboarding docs | E. Therrien |
| DL-002 | 2025-11-21 | Phase 1-1 / 2.1 Offline-First Strategy | Use Drift + sqlite3_flutter_libs for local storage with encrypted columns via future sqlite extensions | Drift gives typed schema migrations + background isolates needed for punch queue; sqlite3_flutter_libs avoids platform SQLite drift; column-level obfuscation handled via app-layer AES until native FFI encryption plugin approved | Scaffold Drift database, add DAO/repository layer, update phased_plan + backend wiring to reference schema | Copilot |
| DL-003 | 2025-11-22 | Phase 1-1 / 2.2 Sync Engine Blueprint | Adopt jittered exponential backoff SyncManager with server-wins conflict policy + duplicate detection | Keeps queue draining offline with deterministic triggers while matching backend expectation that `/api/mobile/punches/batch` returns processed/duplicate/error partitions; limits device churn via five-attempt cap | Implement `SyncManager`, expose DAO helpers, add unit tests, and mirror flow/pseudocode inside `phased_plan.md` + `MOBILE_BACKEND_INTEGRATION_SPEC.md` | Copilot |
| DL-004 | 2025-11-21 | Phase 1-2 / 3.1 Punch Storage | Proceed with plaintext Drift tables plus encryption hooks until Security chooses SQLCipher/AES plugin | We must keep Phase 1-2 work moving while security checklist is pending; wrapping the DB opener behind a swappable factory lets backend/security drop in SQLCipher or record-level AES without refactoring repositories | Annotate plan/spec/code with the interim stance, add TODOs for the eventual key provider, and log a handoff for Security to revisit before Phase 1-3 | Copilot |
| DL-005 | 2025-11-21 | Phase 1-2 / 3.2 Punch Payload | Lock an interim `/api/mobile/punches/batch` payload that wraps drafts with `employee_id`, `device_id`, `app_version`, and expanded metadata even while backend mocks are enabled | Offline queue + analytics require a deterministic schema; publishing an “assumed contract” now unblocks mobile/QA while still inviting Laravel overrides later | Update phased_plan + backend wiring spec with the assumed contract, emit wrapper payloads from the sync transport, and flag backend to override fields if their controller diverges | Copilot |
| DL-006 | 2025-11-21 | Phase 1-2 / 2.x GPS Integration | Adopt a best-effort GPS capture policy (10s high-accuracy request, fallback to cached fix, else mark `gps_unavailable=true`) so punches never block | Field techs must be able to punch even indoors; this policy mirrors product guidance while surfacing accuracy so backend/payroll can review | Document the rule set in plan/spec, add TODO hooks in the future GPS service implementation, and note QA evidence requirements for once the sensor module is built | Copilot |
| DL-007 | 2025-11-21 | Phase 1-2 / 4.4 Server Conflict Handling | Treat backend `invalid_job`, `invalid_timestamp`, and `job_mismatch` codes as dispute-only outcomes that mark punches as synced locally but flagged for follow-up | Ensures pending badges stay accurate while surfacing conflicts for payroll, matching plan requirement to auto-open disputes on job mismatches | Drift schema gains `requiresDispute`, SyncManager flags conflicts + tests cover behavior, backend spec updated with the shared error-code taxonomy | Copilot |
| DL-007 | 2025-11-21 | Phase 1-2 / 4.4 Server Conflict Handling | Flag terminal punch sync errors inside `punches_local` (`lastError`, `requiresDispute`) instead of creating full dispute rows until Phase 1-4 ships the disputes module | Keeps Step 4.4 compliant (duplicates cleared, invalid job/timestamp flagged, job mismatch auto-queues dispute follow-up) without dragging Phase 1-4 tables ahead of schedule | Update schema to add `requiresDispute`, teach `SyncManager` to call the new DAO helpers, and note the interim workflow inside plan/spec/QA logs so foremen know flagged punches will seed disputes later | Copilot |
| DL-008 | 2025-11-21 | Phase 1-2 / 6.3 Crash Recovery | Archive unreadable sync queue rows into `corrupt_queue_entries` and emit UI queue alerts so technicians contact support before data loss | Drift decoding failures were deleting payloads silently after crashes; archiving preserves evidence and alerts crews that a punch requires manual reconciliation | Bump schema to v4, implement `archiveCorruptQueueRow`, add `QueueAlertController` + unsynced banner/snackbar hooks, update `phased_plan.md`, integration spec, and QA log `crash_recovery_tests_2025-11-21.md` | Copilot |

### Guidelines

1. **Create a new ID** for every major decision (format `DL-###`).
2. **Reference the exact section** of `phased_plan.md` or related specs where the decision applies.
3. **Capture rationale** (constraints, trade-offs, data points) so future changes can be evaluated quickly.
4. **List follow-up actions** (doc updates, code changes, QA tasks) and assign an owner.
5. **Cross-link evidence** (PRs, tickets, QA artifacts) when available.

Maintain this log alongside updates to `phased_plan.md`, `COPILOT_BUILD_GUIDE.md`, and backend wiring specs to keep the entire team aligned.
